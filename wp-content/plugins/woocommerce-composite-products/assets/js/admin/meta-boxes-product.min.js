jQuery(function(u){var n=u("select#product-type"),h=u("#bto_product_data"),_=h.find("#_bto_shop_price_calc"),f=h.find(".bulk_toggle_wrapper"),e=u(".config_group",h),i=u(".bto_groups",e),m=u(".bto_group",i),a=m.length,g={},v=u("#bto_scenario_data"),b=v.find(".bulk_toggle_wrapper"),F=u(".scenarios_config_group",v),s=u(".bto_scenarios",v),$=u(".bto_scenario",s),c=$.length,y={},w=u("#bto_state_data"),x=w.find(".bulk_toggle_wrapper"),N=u(".states_config_group",w),r=u(".bto_states",w),k=u(".bto_state",r),d=k.length,C={},P=!1,o={image_frame:!1,$button:!1},l={message:null,overlayCSS:{background:"#fff",opacity:.6}},p={attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200},E=[],J=!1,L=!1,z=w.length,q=!1,T=h.parent().find("#shipping_product_data"),H=u("input#_virtual"),j=u("input#_virtual_composite"),M=H.prop("checked"),Q=!1,W=T.find(".options_group.composite_type"),B=W.find(".bto_type_options li"),t=u("#_sold_individually").closest(".form-field");function G(t){var c=this;this.$el=t,this.$content=t.find(".bto_group_data"),this.$metabox_title=t.find("h3 .group_name"),this.$section_links=this.$content.find(".subsubsub a"),this.$sections=this.$content.find(".tab_group"),this.$discount=this.$content.find(".group_discount"),this.$filters=this.$content.find(".group_filters"),this.$display_prices=this.$content.find(".component_display_prices"),this.$pagination_style=this.$content.find(".component_pagination_style"),this.$query_type_containers=this.$content.find(".component_query_type_selector"),this.$query_type_selector=this.$content.find("select.component_query_type"),this.$options_style_container=this.$content.find(".component_options_style"),this.$options_style_selector=this.$content.find("select.options_style_selector"),this.$categories_selector=this.$content.find("select.categories_selector"),this.$products_selector=this.$content.find("select.products_selector"),this.$default_selectors_container=this.$content.find(".default_selector_container"),this.$default_selectors=this.$content.find(".default_selector_wrapper"),this.$default_selector_categories=this.$content.find("select.default_selector_categories"),this.$default_selector_products=this.$content.find("select.default_selector_products"),this.$optional_checkbox=this.$content.find("input.component_optional"),this.$title_input=this.$content.find("input.group_title"),this.$priced_individually_input=this.$content.find(".group_priced_individually input"),this.$sort_filter_container=this.$content.find(".options_group_component--sort-filter"),this.$show_filters_input=this.$content.find(".group_show_filters input"),this.$min_qty=this.$content.find("div.group_quantity_min"),this.$min_qty_input=this.$min_qty.find("input.group_quantity_min"),this.$max_qty=this.$content.find("div.group_quantity_max"),this.$max_qty_input=this.$max_qty.find("input.group_quantity_max"),this.max_qty_prev=this.$max_qty_input.val(),this.initialized_content=!1,this.component_toggled=function(){var t=c.maybe_initialize_content(),e=this.$el,o=this.$content;setTimeout(function(){e.toggleClass("closed").toggleClass("open"),o.stop().slideToggle()},t?50:10)},this.maybe_initialize_content=function(){var t=!1;return c.initialized_content||(t=!0,c.initialize_content()),t},this.validate_quantity=function(t,e){var o=c.$min_qty_input,n=(o="max"===t?c.$max_qty_input:o).val(),i=parseFloat(o.attr("min")),a=parseFloat(o.attr("max")),o=parseFloat(o.attr("step")),s={qty:n,error:""};return 0<=i&&(n<i||isNaN(n))?"max"===t&&""===n||(s.qty="max"===e?c.max_qty_prev:i,s.error=wc_composite_admin_params.i18n_qty_low_error.replace("%s",i)):0<a&&a<n?(s.qty=a,s.error=wc_composite_admin_params.i18n_qty_high_error.replace("%s",a)):0<o&&0<n&&n%o&&(s.qty=o*Math.ceil(n/o),s.error=wc_composite_admin_params.i18n_qty_step_error.replace("%s",o)),s},this.section_changed=function(t){c.$section_links.removeClass("current"),t.addClass("current"),c.$sections.addClass("tab_group_hidden"),c.$content.find(".tab_group_"+t.data("tab")).removeClass("tab_group_hidden")},this.title_changed=function(){c.$metabox_title.text(c.$title_input.val()),I(!0)},this.query_type_changed=function(){c.$query_type_containers.hide(),c.$default_selectors.hide();var t=c.$query_type_selector.val();c.$content.find(".component_query_type_"+t).show(),this.initialized_content&&(c.toggle_static_component_content(),"category_ids"===t?(c.reinitialize_default_option_category_select(),c.maybe_update_default_option_category_ids(!0)):(c.initialize_default_option_product_select(),c.default_option_changed()),I(!0))},this.products_changed=function(){c.toggle_static_component_content(),c.initialize_default_option_product_select(),c.default_option_changed(),I(!0)},this.categories_changed=function(){var t=c.get_category_ids();c.$default_selector_categories.data("include",t.join()),c.maybe_update_default_option_category_ids(!0),I(!0)},this.optional_changed=function(){c.toggle_static_component_content(),c.default_option_changed(),I(!0)},this.options_style_changed=function(){this.initialized_content&&("yes"!==c.$options_style_selector.find('option[value="'+c.$options_style_selector.val()+'"]').data("supports").pagination||c.is_static()?c.$pagination_style.hide():c.$pagination_style.show())},this.priced_individually_input_changed=function(){c.$priced_individually_input.is(":checked")?(c.$discount.show(),c.$display_prices.show()):(c.$discount.hide(),c.$display_prices.hide())},this.show_filters_input_changed=function(){c.$show_filters_input.is(":checked")?c.$filters.show():c.$filters.hide()},this.toggle_static_component_content=function(){c.is_static()?(c.$options_style_container.hide(),c.$sort_filter_container.hide()):(c.$options_style_container.show(),c.$sort_filter_container.show()),c.options_style_changed()},this.default_option_changed=function(){var t,e=c.$query_type_selector.val(),o=c.get_default_option(),n=c.get_default_option_html(),i=("category_ids"===e?c.$default_selector_categories:c.$default_selector_products).val(),a=!0,s=!1;i||c.is_optional()||("category_ids"===e?"defaults"===_.val()&&0<c.get_category_ids().length&&(s="set_defaults"):0<(t=c.get_product_ids().length)&&("defaults"===_.val()?s="set_defaults":1===t&&(s="set_defaults_static"))),s&&(c.has_error(c.$default_selectors_container)||(setTimeout(function(){c.add_error_tip(c.$default_selectors_container,s)},5),o)||c.add_error(c.$default_selectors_container,s),"product_ids"===e?c.$default_selector_products.val(o).triggerHandler("change"):n&&c.$default_selector_categories.append(n).val(o).triggerHandler("change"),a=!1),a&&(c.clear_error(c.$default_selectors_container),c.set_default_option(i))},this.add_error_tip=function(t,e){var o=t.position();0===t.parent().find(".wc_error_tip").length&&(t.after('<div class="wc_error_tip">'+wc_composite_admin_params["i18n_"+e]+"</div>"),t.parent().find(".wc_error_tip").css("left",o.left+t.width()-t.width()/2-u(".wc_error_tip").width()/2).css("top",o.top+t.height()).fadeIn("100"))},this.add_formatted_error_tip=function(t,e){var o=t.position();0===t.parent().find(".wc_error_tip").length&&(t.after('<div class="wc_error_tip">'+e+"</div>"),t.parent().find(".wc_error_tip").css("left",o.left+t.width()-t.width()/2-u(".wc_error_tip").width()/2).css("top",o.top+t.height()).fadeIn("100"))},this.remove_error_tip=function(t){t.parent().find(".wc_error_tip").fadeOut("100",function(){u(this).remove()})},this.has_error=function(t){return t.hasClass("selection_error")},this.add_error=function(t,e){t.find(".wc-cp-error-tip").attr("data-tip",wc_composite_admin_params["i18n_"+e]),t.find(".wc-cp-error-tip").tipTip(p),t.addClass("selection_error")},this.clear_error=function(t){t.removeClass("selection_error")},this.initialize=function(){c.query_type_changed(),c.options_style_changed(),c.priced_individually_input_changed(),c.show_filters_input_changed()},this.initialize_default_option_category_select=function(){void 0===c.get_default_option_html()&&c.save_default_option_html()},this.reinitialize_default_option_category_select=function(){var t=c.get_default_option(),e=c.get_default_option_html();e&&c.$default_selector_categories.append(e),c.$default_selector_categories.val(t).triggerHandler("change")},this.initialize_default_option_product_select=function(){var t=c.$products_selector.find(":selected").clone().prop("selected",!1).removeAttr("selected").removeAttr("data-select2-id"),e=c.get_default_option()&&0<t.filter('[value="'+c.get_default_option()+'"]').length;c.$default_selector_products.find("option").remove(),c.$default_selector_products.append(t),c.$default_selector_products.prepend("<option/>"),e||(e=!c.is_optional()&&0<t.length&&("defaults"===_.val()||1===t.length)?t.first().val():0,c.set_default_option(e)),c.$default_selector_products.val(c.get_default_option()).triggerHandler("change")},this.initialize_content=function(){"category_ids"===c.$query_type_selector.val()?c.initialize_default_option_category_select():c.initialize_default_option_product_select(),c.initialize_select2s(),c.$content.find(".woocommerce-help-tip").tipTip(p),c.initialized_content=!0},this.initialize_select2s=function(){c.$content.sw_select2({sortable:{stop:function(t){t.hasClass("products_selector")&&(t=t.closest(".bto_group").data("component_metabox_id"),g[t].products_changed())}}})},this.maybe_update_default_option_category_ids=function(e){var t;e=e||!1,null===c.get_default_option_category_ids()?(c.update_default_option_category_ids_xhr&&c.update_default_option_category_ids_xhr.abort(),t={action:"woocommerce_get_product_categories",product_id:c.get_default_option(),security:wc_composite_admin_params.get_product_categories_nonce},c.update_default_option_category_ids_xhr=u.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){c.set_default_option_category_ids("success"===t.result?t.category_ids:[]),e&&c.check_default_option_in_category_ids()})):e&&c.check_default_option_in_category_ids()},this.check_default_option_in_category_ids=function(){(c.get_default_option()&&!c.is_default_option_in_category_ids()||0===c.get_category_ids().length)&&(c.set_default_option(0),c.$default_selector_categories.val(0).trigger("change"))},this.is_default_option_in_category_ids=function(){var t=c.get_selector_data(c.$categories_selector),e=c.get_default_option_category_ids(),o=[],n=(u.each(t,function(t,e){o.push(parseInt(e.id))}),!1);return u.each(e,function(t,e){if(c.array_contains(parseInt(e),o))return!(n=!0)}),n},this.get_default_option_category_ids=function(){return this.$default_selectors_container.data("selected_data").default_option_category_ids},this.set_default_option_category_ids=function(t){this.$default_selectors_container.data("selected_data").default_option_category_ids=t},this.get_default_option_html=function(){return this.$default_selectors_container.data("selected_data").default_option_html},this.save_default_option_html=function(){var t,e=this.$default_selectors_container.data("selected_data");c.get_default_option()?(t=("category_ids"===c.$query_type_selector.val()?c.$default_selector_categories:c.$default_selector_products).find(":selected").clone(),e.default_option_html=t):e.default_option_html=!1},this.get_default_option=function(){return this.$default_selectors_container.data("selected_data").default_option_id||0},this.set_default_option=function(t){var e=this.$default_selectors_container.data("selected_data");e.default_option_id=t||0,c.save_default_option_html(),c.set_default_option_category_ids(!!e.default_option_id&&null),c.maybe_update_default_option_category_ids()},this.get_selector_data=function(t){return t.selectSW("data")},this.get_category_ids=function(){var t=c.get_selector_data(c.$categories_selector),o=[];return u.each(t,function(t,e){o.push(parseInt(e.id))}),o},this.get_product_ids=function(){var t=c.get_selector_data(c.$products_selector),o=[];return u.each(t,function(t,e){o.push(parseInt(e.id))}),o},this.array_contains=function(t,e){return-1!==u.inArray(t,e)},this.is_optional=function(){return c.$optional_checkbox.is(":checked")},this.is_static=function(){var t=c.$query_type_selector.val();if("product_ids"===t&&(1===c.get_product_ids().length&&!c.is_optional()))return!0;return!1},this.initialize()}function I(t){P=t=!!t}function K(){0<m.length?(e.removeClass("no-components"),f.removeClass("disabled")):(e.addClass("no-components"),f.addClass("disabled"))}function R(){g={},m.each(function(t){var e=u(this),t="component_"+t;e.data("component_metabox_id",t),g[t]=new G(e)}),i.sortable({items:".bto_group",cursor:"move",axis:"y",handle:".sort-item",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,placeholder:"wc-metabox-sortable-placeholder",start:function(t,e){e.item.css("background-color","#f6f6f6")},stop:function(t,e){e.item.removeAttr("style"),h.triggerHandler("wc-cp-components-changed")}}),K()}function S(t,e){var p=this;if(t.length&&e.length){if(!(this instanceof S))return new S(t,e);this.templates={row:"wc_cp_condition_row",condition:"wc_cp_%%type%%_condition_content",add:"wc_cp_condition_add_content",component_option:"wc_cp_condition_component_option"},this.os_row_template=!1,this.os_condition_templates={},this.os_add_template=!1,this.os_component_option_template=!1,this.$data_container=1<t.length?t.first():t,this.$components_container=1<e.length?e.first():e,this.$add_container=this.$data_container.find(".os_add"),this.$add_os_select=this.$data_container.find(".os_add select.os_type"),this.$list=this.$data_container.find(".os_list"),this.$boarding=this.$data_container.find(".os_boarding"),this.modifiers=this.$list.data("os_modifiers")?this.$list.data("os_modifiers"):{},this.options_count=parseInt(this.$list.find(".os_row").length,10),this.allow_unique_additions="yes"===this.$data_container.data("unique_additions")?"yes":"no",this.components_select_options=!1,this.$add_container.length&&this.$add_os_select.length&&this.$list.length&&(this.$list.cp_scenario_conditions_scripts(),this.$data_container.on("mousedown",".os_remove .trash",function(){u(this).triggerHandler("mouseleave")}).on("click",".os_remove .trash",function(t){return t.preventDefault(),u(this).closest(".os_row").remove(),p.$data_container.trigger("os_removed",[p]),p.options_count--,p.maybe_add_boarding(),!0}).on("change",".os_modifier select",function(){var t=u(this),o=t.val(),t=t.closest(".os_row_inner").find(".os_value div[data-modifiers]");t.length&&(t.hide(),t.each(function(){var t=u(this),e=t.data("modifiers").split(",");e&&-1!==e.indexOf(o)&&t.show()}))}).on("change",".os_add select.os_type",function(){var e,t=u(this),o=t.val();if("add"!==o){if(p.allow_unique_additions)if(p.$list.find("select.os_type").each(function(){var t=u(this).find(":selected");if(t&&t.length&&o===t.val())return e=u(this),!1}),e&&e.length)return e.trigger("focus"),t.find('option[value="add"]').prop("selected","selected"),!1;var n=p.$components_container.find("#component_query_type_"+o);if(n&&!(n.length<1)){var i,a=parseInt(p.$data_container.attr("data-os_count"),10)+1,s=p.$data_container.attr("data-os_post_name"),c="yes"===n.data("use_ajax")?"ajax":"flat",_=n.data("component_options")?n.data("component_options"):[],n=p.get_os_row_template(),c=p.get_os_condition_template(c),r=p.get_os_component_option_template(),d=p.get_component_select_options();if(n&&c){if(_)for(var l=0;l<_.length;l++)i+=r({option_value:_[l].option_value,option_label:_[l].option_label});n=n({os_index:a,os_components:d,os_content:c({os_post_name:s,os_component_id:o,os_component_options_html:i})}),d=(p.$data_container.attr("data-os_count",a),n=p.prepare_new_row(n),p.$list.append(n),p.$list.find(".os_row").last());d.find('.os_type option[value="'+o+'"]').prop("selected","selected"),p.$data_container.trigger("os_added",[p]),d.cp_scenario_conditions_scripts(),p.options_count++,p.maybe_add_boarding(),t.find('option[value="add"]').prop("selected","selected")}}}return!1}),this.$list.on("change","select.os_type",function(){var t=u(this),e=t.closest(".os_row"),t=t.val(),o=p.$components_container.find("#component_query_type_"+t);if(o&&!(o.length<1)){var n,i=p.$data_container.attr("data-os_post_name"),a="yes"===o.data("use_ajax")?"ajax":"flat",s=o.data("component_options")?o.data("component_options"):[],o=p.get_os_condition_template(a),c=p.get_os_component_option_template();if(o&&c){if(s)for(var _=0;_<s.length;_++)n+=c({option_value:s[_].option_value,option_label:s[_].option_label});a=o({os_post_name:i,os_component_id:t,os_component_options_html:n}),a=p.prepare_new_row(a);e.find(".os_content").html(a),p.$data_container.trigger("os_changed",[p]),e.cp_scenario_conditions_scripts()}}return!1}),this.$components_container.on("wc-cp-components-changed",function(){p.components_select_options=!1}))}}function U(t){var c=this;this.$el=t,this.$content=t.find(".bto_scenario_data"),this.$metabox_title=t.find("h3 .scenario_name .scenario_name_inner"),this.$non_effective_conditions_tip=t.find(".scenario-help-tip--non-effective-conditions"),this.$title_input=this.$content.find("input.bto_scenario_data_title"),this.render_content=this.$content.data("scenario_content"),this.$cc_action_input=this.$content.find("input.scenario_action_conditional_components_input"),this.$co_action_input=this.$content.find("input.scenario_action_conditional_options_input"),this.$cc_component_ids=this.$content.find("select.conditional_components_ids"),this.conditions_stack=!1,this.hidden_options_stack=!1,this.initialized_content=!1,this.scenario_toggled=function(){var t,e,o=this.$el,n=this.$content;J||(e=(t=c.maybe_initialize_content())&&A()?200:t?50:10,setTimeout(function(){o.toggleClass("closed").toggleClass("open"),n.stop().slideToggle({always:function(){t&&A()&&(c.$el.removeClass("loading"),J=!1)}})},e))},this.maybe_initialize_content=function(){var t=!1,e=A()?100:10;return c.initialized_content||(t=!0,A()&&(c.$el.addClass("loading"),J=!0),setTimeout(function(){c.initialize_content()},e)),t},this.title_changed=function(){c.$metabox_title.text(c.$title_input.val())},this.initialize_content=function(){""!==c.render_content&&(c.$content.html(c.render_content),c.$title_input=c.$content.find("input.bto_scenario_data_title"),c.$cc_action_input=c.$content.find("input.scenario_action_conditional_components_input"),c.$co_action_input=c.$content.find("input.scenario_action_conditional_options_input"),c.$cc_component_ids=c.$content.find("select.conditional_components_ids")),c.initialize_select2s(),c.$content.find(".tips, .woocommerce-help-tip").tipTip(p),c.initialized_content=!0,v.triggerHandler("wc-cp-scenario-initialized",c)},this.initialize_select2s=function(){c.$content.sw_select2({sortable:{stop:function(t){t.hasClass("products_selector")&&(t=t.closest(".bto_group").data("component_metabox_id"),g[t].products_changed())}}})},this.update_non_effective_conditions_tip=function(){var n={},t=c.conditions_stack.$add_os_select.find("option"),e=c.conditions_stack.$list.find(".os_row"),o=c.hidden_options_stack.$list.find(".os_row"),i=c.$cc_component_ids.val(),a=0,s=1e4;t.length||c.$non_effective_conditions_tip.fadeOut(200),e.length||c.$non_effective_conditions_tip.fadeOut(200),t.each(function(t,e){e=u(e).val();if("add"===e)return!0;n[e]=t}),e.each(function(t,e){var o=u(e).find("select.os_type").val();if("in-any"===u(e).find(".os_modifier select").val())return!0;a<n[o]&&(a=n[o])}),c.$cc_action_input.is(":checked")&&u.each(i,function(t,e){n[e]<s&&(s=n[e])}),c.$co_action_input.is(":checked")&&o.each(function(t,e){e=u(e).find("select.os_type").val();n[e]<s&&(s=n[e])}),s<=a?c.$non_effective_conditions_tip.fadeIn(200):c.$non_effective_conditions_tip.fadeOut(200)},this.initialize=function(){c.$non_effective_conditions_tip.tipTip(p)},this.initialize()}function A(){return 20<m.length}function V(){0<$.length?b.removeClass("disabled"):b.addClass("disabled")}function X(){y={},$.each(function(t){var e=u(this),t="scenario_"+t;e.data("scenario_metabox_id",t),y[t]=new U(e)}),s.sortable({items:".bto_scenario",cursor:"move",axis:"y",handle:".sort-item",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,placeholder:"wc-metabox-sortable-placeholder",start:function(t,e){e.item.css("background-color","#f6f6f6")},stop:function(t,e){e.item.removeAttr("style"),v.triggerHandler("wc-cp-scenarios-changed")}}),V()}u.each(wc_composite_admin_params.layouts,function(t,e){E.push("layout-"+e)}),u(".composite_stock_msg").appendTo("._manage_stock_field .description"),t.addClass("hide_if_composite"),t.siblings(".woocommerce-help-tip").addClass("hide_if_composite"),u("#linked_product_data .grouping.show_if_simple, #linked_product_data .form-field.show_if_grouped").addClass("hide_if_composite"),u(".show_if_simple:not(.hide_if_composite)").addClass("show_if_composite"),"undefined"==typeof woocommerce_admin_meta_boxes&&(woocommerce_admin_meta_boxes=woocommerce_writepanel_params),u("body").on("woocommerce-product-type-change",function(t,e){"composite"===e&&(u(".show_if_external").hide(),u(".show_if_composite").show(),u("input#_manage_stock").trigger("change"),Q&&j.prop("checked",H.prop("checked")),j.prop("checked")||H.prop("checked",!1).change(),"unassembled"===B.find("input.composite_type_option:checked").first().val())&&(T.addClass("composite_unassembled"),h.addClass("composite_unassembled"))}),H.on("change",function(){H.prop("checked")!==M&&(Q=!0)}),u("form#post").on("submit",function(){var t,e,o;"composite"===n.val()&&(t=u(this),e=u('<input type="hidden" name="cp_post_control_var" value="1"/>'),o=u('<input type="hidden" name="cp_post_test_var" value="1"/>'),t.prepend(e),t.append(o))}),u("input#_downloadable").on("change",function(){n.trigger("change")}),_.data("val",_.val()),h.off("click").on("click",".bto_layout_label",function(){var t=u(this);t.closest(".bto_layouts").find(".selected").removeClass("selected"),t.addClass("selected"),e.removeClass(E.join(" ")),e.addClass("layout-"+t.find("input").val())}).on("change","#_bto_shop_price_calc",function(){var t=u(this).val(),o=!1;"defaults"===t&&u.each(g,function(t,e){if(!e.is_optional()&&!e.get_default_option())return o=!0,window.alert(wc_composite_admin_params.i18n_defaults_unset),_.val(_.data("val")),!1}),o||_.data("val",t)}).one("wc-cp-component-added",function(){e.removeClass("options_group--boarding")}).on("wc-cp-components-changed",function(){i=u(".bto_groups",e),(m=u(".bto_group",i)).each(function(t,e){u(".group_position",e).val(t),u(e).attr("rel",t)}),I(!0),K()}),v.off("click").one("wc-cp-scenario-added",function(){F.removeClass("options_group--boarding")}).on("wc-cp-scenarios-changed",function(){s=u(".bto_scenarios",v),($=u(".bto_scenario",s)).each(function(t,e){u(".scenario_position",e).val(t),u(e).attr("rel",t)}),V()}),z&&w.off("click").one("wc-cp-state-added",function(){N.removeClass("options_group--boarding")}).on("wc-cp-states-changed",function(){r=u(".bto_states",w),(k=u(".bto_state",r)).each(function(t,e){u(".state_position",e).val(t),u(e).attr("rel",t)}),tt()}),e.on("click",".expand_all",function(){return u(this).hasClass("disabled")||u.each(g,function(t,e){e.initialize_content(),setTimeout(function(){e.$el.addClass("open").removeClass("closed"),e.$content.show()},50)}),!1}).on("click",".close_all",function(){return u(this).hasClass("disabled")||u.each(g,function(t,e){setTimeout(function(){e.$el.addClass("closed").removeClass("open"),e.$content.hide()},10)}),!1}).on("click",".bto_group_handle",function(){var t=u(this).closest(".bto_group").data("component_metabox_id"),t=g[t];void 0!==t&&t.component_toggled()}).on("click",".bto_group_handle .component-id-item",function(){return!1}).on("click",".subsubsub a",function(t){var e=u(this),o=u(this).closest(".bto_group").data("component_metabox_id");g[o].section_changed(e),t.preventDefault()}).on("click","a.remove_row",function(t){var e=u(this).closest(".bto_group"),o=e.data("component_metabox_id");e.find("*").off(),e.remove(),delete g[o],h.triggerHandler("wc-cp-components-changed"),t.preventDefault()}).on("click","button.add_bto_group",function(){h.block(l),a++;var t={action:"woocommerce_add_composite_component",post_id:woocommerce_admin_meta_boxes.post_id,id:a,security:wc_composite_admin_params.add_component_nonce};return setTimeout(function(){u.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){i.append(t);var t=u(".bto_group",i).last(),e=new G(t),o="component_"+a;t.data("component_metabox_id",o),g[o]=e,h.triggerHandler("wc-cp-components-changed"),e.initialize_content(),h.triggerHandler("wc-cp-component-added",[e]),h.unblock()})},250),!1}).on("keyup","input.group_title",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].title_changed()}).on("change","select.component_query_type",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].query_type_changed()}).on("change","select.categories_selector",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].categories_changed()}).on("change","select.products_selector",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].products_changed()}).on("change","select.default_selector_categories",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].default_option_changed()}).on("change","select.default_selector_products",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].default_option_changed()}).on("change","input.component_optional",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].optional_changed()}).on("change","select.options_style_selector",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].options_style_changed()}).on("change",".group_priced_individually input",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].priced_individually_input_changed()}).on("input change","input.group_quantity",function(t){var e,o,n=u(this),i=n.closest(".bto_group").data("component_metabox_id"),a=g[i],i="min",s=(n.hasClass("group_quantity_max")&&(i="max"),a.validate_quantity(i,i));s.error?"input"===event.type?setTimeout(function(){a.add_formatted_error_tip(n,s.error)},5):n.val(s.qty).change():(a.remove_error_tip(n),"change"===event.type&&(e=a.$min_qty_input.val(),o=a.$max_qty_input.val(),a.$max_qty_input.attr("min",e),(s=a.validate_quantity("max",i)).error&&(a.$max_qty_input.val(s.qty),o=s.qty),a.max_qty_prev=o))}).on("change",".group_show_filters input",function(){var t=u(this).closest(".bto_group").data("component_metabox_id");g[t].show_filters_input_changed()}).on("click",".upload_component_image_button",function(t){o.$button=u(this),t.preventDefault(),o.image_frame||(o.image_frame=wp.media({title:wc_composite_admin_params.i18n_choose_component_image,button:{text:wc_composite_admin_params.i18n_set_component_image},states:[new wp.media.controller.Library({title:wc_composite_admin_params.i18n_choose_component_image,filterable:"all"})]}),o.image_frame.on("select",function(){var t=o.image_frame.state().get("selection").first().toJSON(),e=(t.sizes&&t.sizes.thumbnail?t.sizes.thumbnail:t).url;o.$button.addClass("has_image"),o.$button.closest(".component_image").find(".remove_component_image_button").addClass("has_image"),o.$button.find("input").val(t.id).trigger("change"),o.$button.find("img").eq(0).attr("src",e)})),o.image_frame.open()}).on("click",".remove_component_image_button",function(t){var e=u(this),o=e.closest(".component_image"),n=o.find(".upload_component_image_button");t.preventDefault(),n.removeClass("has_image"),e.removeClass("has_image"),o.find("input").val("").trigger("change"),n.find("img").eq(0).attr("src",wc_composite_admin_params.wc_placeholder_img_src)}),R(),S.prototype={reset_options:function(){this.$list.html(""),this.$data_container.attr("data-filters_count",0),this.options_count=0,this.maybe_add_boarding()},get_os_row_template:function(){var t=!1;return"function"==typeof this.os_row_template?t=this.os_row_template:(t=wp.template(this.templates.row),this.os_row_template=t),t},get_os_condition_template:function(t){var e,o=!1;return"function"==typeof this.os_condition_templates[t]?o=this.os_condition_templates[t]:(e=(e=this.templates.condition).replace("%%type%%",t),o=wp.template(e),this.os_condition_templates[t]=o),o},get_os_add_template:function(){var t=!1;return"function"==typeof this.os_add_template?t=this.os_add_template:(t=wp.template(this.templates.add),this.os_add_template=t),t},get_os_component_option_template:function(){var t=!1;return"function"==typeof this.os_component_option_template?t=this.os_component_option_template:(t=wp.template(this.templates.component_option),this.os_component_option_template=t),t},maybe_add_boarding:function(){0==this.options_count?(this.$data_container.addClass("os_empty"),this.$list.addClass("hidden"),this.$boarding.addClass("active"),this.$add_container.addClass("os_add--boarding")):(this.$data_container.removeClass("os_empty"),this.$list.removeClass("hidden"),this.$boarding.removeClass("active"),this.$add_container.removeClass("os_add--boarding"))},prepare_new_row:function(t){t=u(t);if(!u.isEmptyObject(this.modifiers)){var e,o=t.find(".os_modifier select"),n="";for(e in this.modifiers)n+="<option value="+e+">"+this.modifiers[e]+"</option>";o.html(n)}return t},get_component_select_options:function(){var e="";return!1!==this.components_select_options?e=this.components_select_options:(this.$add_container.find("select.os_type").children().each(function(){var t=u(this);"add"!==t.val()&&(e+='<option value="'+t.val()+'">'+t.text()+"</option>")}),this.components_select_options=e),e}},u.fn.cp_scenario_conditions_scripts=function(){var t=u(this);t.sw_select2(),t.find(".woocommerce-help-tip, .help_tip, .tips").tipTip(p)},v.on("wc-cp-scenario-initialized",function(t,e){var o=e.$content.find(".wc-cp-scenario-conditions-container"),o=(o&&o.length&&(e.conditions_stack=new S(o,h)),e.$content.find(".action_options .os_container"));o&&o.length&&(e.hidden_options_stack=new S(o,h))}),F.on("click",".expand_all",function(){return u(this).hasClass("disabled")||u.each(y,function(t,e){e.initialize_content(),setTimeout(function(){e.$el.addClass("open").removeClass("closed"),e.$content.show()},50)}),!1}).on("click",".close_all",function(){return u(this).hasClass("disabled")||u.each(y,function(t,e){setTimeout(function(){e.$el.addClass("closed").removeClass("open"),e.$content.hide()},10)}),!1}).on("click",".bto_scenario_handle",function(){var t=u(this).closest(".bto_scenario").data("scenario_metabox_id"),t=y[t];void 0!==t&&t.scenario_toggled()}).on("click","a.remove_row",function(t){var e=u(this).closest(".bto_scenario"),o=e.data("scenario_metabox_id");e.find("*").off(),e.remove(),delete y[o],v.triggerHandler("wc-cp-scenarios-changed"),t.preventDefault()}).on("keyup","input.bto_scenario_data_title",function(){var t=u(this).closest(".bto_scenario").data("scenario_metabox_id");y[t].title_changed()}).on("change",".toggle_scenario_action_config input",function(){var t=u(this),e=t.is(":checked"),t=t.closest(".scenario_action_config_group").find(".action_config");t&&t.length&&(e?t.show():t.hide())}).on("click",".woocommerce-input-toggle",function(){var t=u(this),e=t.closest(".wc-metabox");return nt(t,e.find(".bto_scenario_handle .handle > input.enabled")),!1}).on("click","button.add_bto_scenario",function(){v.block(l),c++;var t={action:"woocommerce_add_composite_scenario",post_id:woocommerce_admin_meta_boxes.post_id,id:c,security:wc_composite_admin_params.add_scenario_nonce};return setTimeout(function(){u.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){s.append(t);var t=u(".bto_scenario",s).last(),e=new U(t),o="scenario_"+c;t.data("scenario_metabox_id",o),y[o]=e,v.triggerHandler("wc-cp-scenarios-changed"),e.initialize_content(),v.triggerHandler("wc-cp-scenario-added",[e]),v.unblock()})},250),!1}).on("change","input.scenario_action_conditional_options_input, input.scenario_action_conditional_components_input, select.conditional_components_ids, .wc-cp-scenario-conditions-container .os_modifier select",function(){var t=u(this).closest(".bto_scenario").data("scenario_metabox_id");y[t].update_non_effective_conditions_tip()}).on("os_removed os_changed os_added",function(t,e){e=e.$data_container.closest(".bto_scenario").data("scenario_metabox_id");y[e].update_non_effective_conditions_tip()}),X();var O,t=u(".cp_scenarios_tab"),Y=t.find("a"),t=(t.prepend('<a class="cp_scenarios_tab_inner" href="#bto_scenario_data"></a>'),t.find("a.cp_scenarios_tab_inner"));function Z(t){var i=this;this.$el=t,this.$content=t.find(".bto_state_data"),this.$metabox_title=t.find("h3 .state_name .state_name_inner"),this.$title_input=this.$content.find("input.bto_state_data_title"),this.render_content=this.$content.data("state_content"),this.initialized_content=!1,this.state_toggled=function(){var t,e,o=this.$el,n=this.$content;L||(e=(t=i.maybe_initialize_content())&&D()?200:t?50:10,setTimeout(function(){o.toggleClass("closed").toggleClass("open"),n.stop().slideToggle({always:function(){t&&D()&&(i.$el.removeClass("loading"),L=!1)}})},e))},this.maybe_initialize_content=function(){var t=!1,e=D()?100:10;return i.initialized_content||(t=!0,D()&&(i.$el.addClass("loading"),L=!0),setTimeout(function(){i.initialize_content()},e)),t},this.title_changed=function(){i.$metabox_title.text(i.$title_input.val())},this.initialize_content=function(){""!==i.render_content&&(i.$content.html(i.render_content),i.$title_input=i.$content.find("input.bto_state_data_title")),i.initialize_select2s(),i.$content.find(".tips, .woocommerce-help-tip").tipTip(p),i.initialized_content=!0,w.triggerHandler("wc-cp-state-initialized",i)},this.initialize_select2s=function(){i.$content.sw_select2({sortable:{stop:function(t){t.hasClass("products_selector")&&(t=t.closest(".bto_group").data("component_metabox_id"),g[t].products_changed())}}})},this.initialize=function(){},this.initialize()}function D(){return 20<m.length}function tt(){0<k.length?x.removeClass("disabled"):x.addClass("disabled")}function et(){C={},k.each(function(t){var e=u(this),t="state_"+t;e.data("state_metabox_id",t),C[t]=new Z(e)}),r.sortable({items:".bto_state",cursor:"move",axis:"y",handle:".sort-item",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,placeholder:"wc-metabox-sortable-placeholder",start:function(t,e){e.item.css("background-color","#f6f6f6")},stop:function(t,e){e.item.removeAttr("style"),w.triggerHandler("wc-cp-states-changed")}}),tt()}function ot(){N.on("click",".expand_all",function(){return u(this).hasClass("disabled")||u.each(C,function(t,e){e.initialize_content(),setTimeout(function(){e.$el.addClass("open").removeClass("closed"),e.$content.show()},50)}),!1}).on("click",".close_all",function(){return u(this).hasClass("disabled")||u.each(C,function(t,e){setTimeout(function(){e.$el.addClass("closed").removeClass("open"),e.$content.hide()},10)}),!1}).on("click",".bto_state_handle",function(){var t=u(this).closest(".bto_state").data("state_metabox_id"),t=C[t];void 0!==t&&t.state_toggled()}).on("click","a.remove_row",function(t){var e=u(this).closest(".bto_state"),o=e.data("state_metabox_id");e.find("*").off(),e.remove(),delete C[o],w.triggerHandler("wc-cp-states-changed"),t.preventDefault()}).on("keyup","input.bto_state_data_title",function(){var t=u(this).closest(".bto_state").data("state_metabox_id");C[t].title_changed()}).on("click",".woocommerce-input-toggle",function(){var t=u(this),e=t.closest(".wc-metabox");return nt(t,e.find(".bto_state_handle .handle > input.enabled")),!1}).on("click","button.add_bto_state",function(){w.block(l),d++;var t={action:"woocommerce_add_composite_state",post_id:woocommerce_admin_meta_boxes.post_id,id:d,security:wc_composite_admin_params.add_state_nonce};return setTimeout(function(){u.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){r.append(t);var t=u(".bto_state",r).last(),e=new Z(t),o="state_"+d;t.data("state_metabox_id",o),C[o]=e,w.triggerHandler("wc-cp-states-changed"),e.initialize_content(),w.triggerHandler("wc-cp-state-added",[e]),w.unblock()})},250),!1}),et()}function nt(t,e){"yes"===e.val()?(e.val("no"),t.removeClass("woocommerce-input-toggle--enabled").addClass("woocommerce-input-toggle--disabled")):(e.val("yes"),t.removeClass("woocommerce-input-toggle--disabled").addClass("woocommerce-input-toggle--enabled"))}function it(){h.block(l),v.block(l),z&&w.block(l),m.find("*").off();var t={post_id:woocommerce_admin_meta_boxes.post_id,data:u("#bto_product_data, #bto_scenario_data, #bto_state_data").find("input, select, textarea").serialize(),action:"woocommerce_bto_composite_save",security:wc_composite_admin_params.save_composite_nonce};setTimeout(function(){q=u.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){"success"!==t.result&&window.alert(wc_composite_admin_params.i18n_save_error);var e=t.notices,t=t.html,o=[],n=u("#bto_config_group_inner",h),i=u(t).find("#bto_config_group_inner"),a=i.find(".bto_group"),s=[],c=u("#bto_scenarios_inner",v),_=u(t).find("#bto_scenarios_inner"),r=_.find(".bto_scenario"),d=[],l=u("#bto_states_inner",w),t=u(t).find("#bto_states_inner"),p=t.find(".bto_state");m.length===a.length&&m.each(function(){var t=u(this);t.hasClass("open")&&(t=t.attr("rel"),o.push(t))}),a.each(function(){var t=u(this),e=t.attr("rel");-1!==u.inArray(e,o)?(t.addClass("open").removeClass("closed"),t.find(".wc-metabox-content").show()):t.find(".wc-metabox-content").hide()}),$.length===r.length&&c.find(".bto_scenario").each(function(){var t=u(this);t.hasClass("open")&&(t=t.attr("rel"),s.push(t))}),r.each(function(){var t=u(this),e=t.attr("rel");-1!==u.inArray(e,s)?(t.addClass("open").removeClass("closed"),t.find(".wc-metabox-content").show()):t.find(".wc-metabox-content").hide()}),m.find("*").off(),$.find("*").off(),n.html(i.html()),c.html(_.html()),f=n.find(".bulk_toggle_wrapper"),b=c.find(".bulk_toggle_wrapper"),h.triggerHandler("wc-cp-components-changed"),R(),v.triggerHandler("wc-cp-scenarios-changed"),X(),m.each(function(){var t=u(this);t.hasClass("open")&&(t=t.data("component_metabox_id"),g[t].initialize_content())}),$.each(function(){var t=u(this);t.hasClass("open")&&(t=t.data("scenario_metabox_id"),y[t].initialize_content())}),z&&(k.length===p.length&&l.find(".bto_state").each(function(){var t=u(this);t.hasClass("open")&&(t=t.attr("rel"),d.push(t))}),p.each(function(){var t=u(this),e=t.attr("rel");-1!==u.inArray(e,d)?(t.addClass("open").removeClass("closed"),t.find(".wc-metabox-content").show()):t.find(".wc-metabox-content").hide()}),k.find("*").off(),l.html(t.html()),x=l.find(".bulk_toggle_wrapper"),w.triggerHandler("wc-cp-states-changed"),et(),k.each(function(){var t=u(this);t.hasClass("open")&&(t=t.data("state_metabox_id"),C[t].initialize_content())})),0<e.length&&u.each(e,function(t,e){window.alert(e)}),h.unblock(),v.unblock(),z&&w.unblock(),I(q=!1)},"json")},250)}t.html(Y.html()),t.on("click",function(){return P&&!q?window.confirm(wc_composite_admin_params.i18n_scenarios_panel_blocked)&&(Y.trigger("click"),setTimeout(function(){it()},150)):Y.trigger("click"),!1}),z&&w.on("wc-cp-state-initialized",function(t,e){e=e.$content.find(".wc-cp-state-conditions-container");e.length&&new S(e,h)}),z&&(ot(),t=u(".cp_states_tab"),O=t.find("a"),t.prepend('<a class="cp_states_tab_inner" href="#bto_scenario_data"></a>'),(t=t.find("a.cp_states_tab_inner")).html(O.html()),t.on("click",function(){return P&&!q?window.confirm(wc_composite_admin_params.i18n_states_panel_blocked)&&(O.trigger("click"),setTimeout(function(){it()},150)):O.trigger("click"),!1})),"yes"===wc_composite_admin_params.is_first_composite&&(n.val("composite").trigger("change").trigger("focus"),setTimeout(function(){u(".composite_product_options a").trigger("click")},500)),W.detach().prependTo(T),T.find(".form-field._weight_field").after(W.find(".form-field.composite_aggregate_weight_field")),j.on("change",function(){var t=j.prop("checked");H.prop("checked")!==t&&H.prop("checked",t).trigger("change"),t?h.addClass("composite_virtual"):h.removeClass("composite_virtual")}),B.on("click",function(){var t=u(this),e=t.find("input").prop("checked","checked").val();B.removeClass("selected"),t.addClass("selected"),"assembled"===e?(T.removeClass("composite_unassembled"),h.removeClass("composite_unassembled")):"unassembled"===e&&(T.addClass("composite_unassembled"),h.addClass("composite_unassembled"))}),n.trigger("change")});